# A2 â€“ Ð’Ð¸Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ Î» Ð´Ð»Ñ Ð·Ð°Ð´Ð°Ð½Ð¾Ð³Ð¾ Ï‰

# ÐœÐµÑ‚Ð°:
# Ð—Ð½Ð°Ð¹Ñ‚Ð¸ Î» âˆˆ ð”½_q Ñ‚Ð°ÐºÐµ, Ñ‰Ð¾:     Ï†(P) = (Ï‰x, y) = [Î»]P
# Ð¦Ðµ Î» Ð±ÑƒÐ´Ðµ Ð²Ð»Ð°ÑÐ½Ð¸Ð¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½ÑÐ¼ ÐµÐ½Ð´Ð¾Ð¼Ð¾Ñ€Ñ„Ñ–Ð·Ð¼Ñƒ Ï†, ÑÐºÐµ ÑƒÐ·Ð³Ð¾Ð´Ð¶ÐµÐ½Ð¾ Ð· Ï‰, Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¸Ð¼ Ñƒ A1.

# ÐœÐµÑ‚Ð¾Ð´
# - ÐžÑÐºÑ–Ð»ÑŒÐºÐ¸ Ï†Â³ = id, Ñ‚Ð¾ Î» Ð¿Ð¾Ð²Ð¸Ð½Ð½Ð¾ Ð·Ð°Ð´Ð¾Ð²Ð¾Ð»ÑŒÐ½ÑÑ‚Ð¸:
#       Î»Â² + Î» + 1 â‰¡ 0 mod q
# - Ð Ð¾Ð·Ð²'ÑÐ·ÐºÐ¸ Ñ†ÑŒÐ¾Ð³Ð¾ Ñ€Ñ–Ð²Ð½ÑÐ½Ð½Ñ:
#       Î» = (â€“1 Â± âˆšâ€“3)/2 mod q
# - ÐŸÑ–ÑÐ»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ð¾Ð±Ð¸Ð´Ð²Ð¾Ñ… Î», Ð·Ð°Ð»Ð¸ÑˆÐ¸Ð»Ð¸ Ñ‚Ðµ, Ð´Ð»Ñ ÑÐºÐ¾Ð³Ð¾:
#       Ï†(G) = [Î»]G Ð´Ð»Ñ G = (1, 2)


from sympy.ntheory import sqrt_mod

p = 0x30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd47
q = 0x30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001
omega = 21888242871839275220042445260109153167277707414472061641714758635765020556616
G = (1, 2)
phiG = (omega, 2)

# ÐžÐ±Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½Ñ ÐºÐ¾Ñ€ÐµÐ½Ñ–Ð² Ð· â€“3 mod q
neg3 = (-3) % q
roots = sqrt_mod(neg3, q, all_roots=True)

# ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¸ Ð½Ð° Î» = (â€“1 Â± âˆšâ€“3)/2 mod q
lambdas = [(( -1 + r ) * pow(2, -1, q)) % q for r in roots]

# Ð•Ð»Ñ–Ð¿Ñ‚Ð¸Ñ‡Ð½Ð° Ð°Ñ€Ð¸Ñ„Ð¼ÐµÑ‚Ð¸ÐºÐ°
def point_add(P, Q):
    if P is None: return Q
    if Q is None: return P
    x1, y1 = P
    x2, y2 = Q
    if x1 == x2 and y1 != y2: return None
    if P == Q:
        m = (3 * x1 * x1) * pow(2 * y1, -1, p) % p
    else:
        m = (y2 - y1) * pow(x2 - x1, -1, p) % p
    x3 = (m * m - x1 - x2) % p
    y3 = (m * (x1 - x3) - y1) % p
    return (x3, y3)

def scalar_mult(k, P):
    R = None
    while k:
        if k & 1:
            R = point_add(R, P)
        P = point_add(P, P)
        k >>= 1
    return R

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°: Ï†(G) == [Î»]G ?
for idx in range(len(lambdas)):
    lam = lambdas[idx]
    result = scalar_mult(lam, G)
    print("Î» =", lam)
    print("Ï†(G) =", phiG)
    print("[Î»]G =", result)
    print("Ï†(G) == [Î»]G:", result == phiG)
    print("---")
